<section class="page-head">
  <h1 class="page-title"><%= @post.title %></h1>
  <div class="post-meta">
    <span><%= pluralize(@post.score, "point") %></span>
    <span>by <%= @post.author_name %></span>
    <% if @post.source == "hacker_news" && @post.hn_rank.present? %>
      <span>rank #<%= @post.hn_rank %> on hn</span>
    <% end %>
    <span>posted <%= time_ago_in_words(@post.created_at) %> ago</span>
  </div>
</section>

<article class="content-card">
  <% if @post.source_image_url.present? %>
    <img src="<%= @post.source_image_url %>" alt="<%= @post.title %>" class="post-image" loading="lazy">
  <% else %>
    <img alt="Shrug reaction" class="post-image post-image-fallback" data-giphy-query="shrug lol" data-giphy-cache-key="post:<%= @post.id %>" hidden loading="lazy">
  <% end %>

  <% if @post.source_domain.present? %>
    <p class="page-subtitle">Source: <%= @post.source_domain %></p>
  <% end %>

  <% if @post.display_description.present? %>
    <p class="post-description"><%= @post.display_description %></p>
  <% end %>

  <% if @post.url.present? %>
    <p>
      <%= link_to "Read Full Article", @post.url, target: "_blank", rel: "noopener", class: "hn-link" %>
    </p>
  <% end %>

  <% if @post.text.present? %>
    <div class="post-body">
      <%= simple_format(@post.text) %>
    </div>
  <% elsif @post.url.blank? %>
    <p class="empty-state">No content is available for this post yet.</p>
  <% end %>
</article>

<section class="content-card post-body">
  <h2>Discussion</h2>
  <% if @post.hn_discussion_url.present? %>
    <p><%= link_to "View Discussion on Hacker News", @post.hn_discussion_url, target: "_blank", rel: "noopener", class: "hn-link" %></p>
    <p class="page-subtitle"><%= pluralize(@post.comment_count, "comment") %> on Hacker News.</p>
  <% else %>
    <p class="empty-state">Discussion link is not available for this item.</p>
  <% end %>

  <% if @comments.any? %>
    <div class="hn-comments">
      <% @comments.each do |comment| %>
        <article class="hn-comment" style="--depth: <%= [comment.depth, 8].min %>;">
          <p class="hn-comment-meta">
            <strong><%= comment.display_author %></strong>
            <% if comment.posted_at.present? %>
              <span><%= time_ago_in_words(comment.posted_at) %> ago</span>
            <% end %>
          </p>
          <div class="hn-comment-body">
            <%= sanitize(comment.display_body_html, tags: %w[p br a pre code i em b strong blockquote ul ol li], attributes: %w[href title]) %>
          </div>
        </article>
      <% end %>
    </div>
  <% else %>
    <p class="empty-state">No comments fetched yet for this story.</p>
    <% if @post.comment_count.positive? %>
      <p><%= link_to "Load comments", post_path(@post, load_comments: 1), class: "top-link" %></p>
    <% end %>
  <% end %>
</section>

<%= link_to "Back to posts", posts_path, class: "back-link" %>
