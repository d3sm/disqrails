<section class="card p-4 mt-4">
  <div class="flex items-center gap-3">
    <h2 class="mt-0 text-lg">Discussion</h2>
    <nav class="flex gap-2 text-sm ml-auto">
      <% comment_sort = local_assigns[:comment_sort] || "threaded" %>
      <% { "threaded" => "Threaded", "newest" => "Newest", "oldest" => "Oldest" }.each do |mode, label| %>
        <%= link_to label, post_path(post, comment_sort: mode),
          class: "no-underline #{comment_sort == mode ? 'text-primary font-bold' : 'text-muted hover:text-accent'}" %>
      <% end %>
    </nav>
  </div>

  <% if current_user %>
    <div class="mt-3 mb-4">
      <%= form_with url: post_comments_path(post), method: :post, local: true, class: "grid gap-2" do %>
        <%= text_area_tag :body, nil, rows: 3, required: true, placeholder: "Add a comment...", class: "w-full px-3 py-2.5 rounded-btn border border-line bg-white text-primary font-inherit focus:outline-2 focus:outline-accent-light focus:outline-offset-1 focus:border-accent" %>
        <%= submit_tag "Comment", class: "w-fit bg-accent text-white rounded-lg px-4 py-1.5 cursor-pointer hover:brightness-[0.94]" %>
      <% end %>
    </div>
  <% end %>

  <% local_comments = local_assigns.fetch(:local_comments, []) %>
  <% if local_comments.any? %>
    <% by_parent_id = Hash.new { |h, k| h[k] = [] } %>
    <% roots = [] %>
    <% local_comments.each do |comment| %>
      <% if comment.parent_id.present? %>
        <% by_parent_id[comment.parent_id] << comment %>
      <% else %>
        <% roots << comment %>
      <% end %>
    <% end %>
    <% sort_comments = ->(list) { list.sort_by { |c| [c.position || 0, c.id] } } %>
    <% render_comment = nil %>
    <% render_comment = lambda do |comment| %>
      <% children = sort_comments.call(by_parent_id[comment.id] || []) %>
      <%= render "comments/comment", comment: comment, post: post, children: children, sort_comments: sort_comments, render_comment: render_comment, user_reactions: local_assigns.fetch(:user_reactions, {}) %>
    <% end %>
    <div class="mt-3.5">
      <% sort_comments.call(roots).each { |comment| render_comment.call(comment) } %>
    </div>
  <% else %>
    <% unless current_user %>
      <p class="my-0.5 text-muted">No comments yet.</p>
    <% end %>
  <% end %>

  <% if post.external_id.present? && post.external_source? %>
    <div class="mt-4 pt-3 border-t border-t-line">
      <% external_comments = local_assigns.fetch(:external_comments, []) %>
      <% comments_loaded = local_assigns.fetch(:external_comments_loaded, false) %>

      <% if comments_loaded %>
        <details id="external-comments">
          <summary class="cursor-pointer text-accent text-base font-medium">
            <%= post.external_source_name %> comments (<%= external_comments.size %>)
          </summary>
          <%= render "posts/external_comments", post: post, external_comments: external_comments, user_reactions: local_assigns.fetch(:user_reactions, {}) %>
        </details>
      <% else %>
        <%= turbo_frame_tag "external-comments" do %>
          <%= link_to load_external_comments_post_path(post),
            data: { turbo_frame: "external-comments" },
            class: "text-accent text-base font-medium no-underline hover:underline" do %>
            Load <%= post.external_source_name %> comments<%= " (#{post.comment_count})" if post.comment_count > 0 %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% end %>
</section>
